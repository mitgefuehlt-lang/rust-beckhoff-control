name: Deploy to NixOS Mini PC

on:
  workflow_dispatch:


jobs:
  deploy:
    runs-on: self-hosted
    # Only allow one deployment at a time to avoid lock contention
    concurrency: production_deploy
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Update Flake Lock
        # Optional: ensure we are using fresh dependencies if desired, 
        # but usually we want to deploy exactly what is in the lockfile.
        # So we skip updating the lockfile here to ensure determinism.
        run: echo "Using existing flake.lock"

      - name: Rebuild NixOS
        run: /run/current-system/sw/bin/nixos-rebuild switch --flake .
          
      - name: Verify Service Status
        run: |
          systemctl is-active qitech.service || echo "Warning: qitech service not active!"
