name: Deploy to NixOS Mini PC (System Update)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency: production_deploy
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Secrets
        id: sanitize
        run: |
          CLIENT_ID=$(echo "${{ secrets.TS_OAUTH_CLIENT_ID }}" | xargs)
          CLIENT_SECRET=$(echo "${{ secrets.TS_OAUTH_SECRET }}" | xargs)
          echo "CLEAN_CLIENT_ID=$CLIENT_ID" >> $GITHUB_ENV
          echo "::add-mask::$CLIENT_ID"
          echo "CLEAN_CLIENT_SECRET=$CLIENT_SECRET" >> $GITHUB_ENV
          echo "::add-mask::$CLIENT_SECRET"

      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ env.CLEAN_CLIENT_ID }}
          oauth-secret: ${{ env.CLEAN_CLIENT_SECRET }}
          tags: tag:ci

      - name: Rebuild NixOS via SSH
        run: |
          ssh -o StrictHostKeyChecking=no konrad@nixos "cd /run/github-runner/nix-runner/rust-beckhoff-control/rust-beckhoff-control && sudo nixos-rebuild switch --flake . || echo 'Rebuild finished with warnings/errors, likely due to service restart'"
          
      - name: Verify Service Status
        run: |
          ssh -o StrictHostKeyChecking=no konrad@nixos "systemctl is-active qitech-control-server || echo 'Service not active yet, standard on first boot/switch'"
