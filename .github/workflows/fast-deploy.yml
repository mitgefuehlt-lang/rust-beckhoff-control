name: Fast Deploy (Binary Only)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - 'control-core/**'
      - 'Cargo.toml'
      - 'Cargo.lock'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcap-dev libudev-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Debug Secrets
        run: |
          if [ -z "${{ secrets.TS_OAUTH_CLIENT_ID }}" ]; then echo "::error::❌ TS_OAUTH_CLIENT_ID is EMPTY! Check GitHub Secrets."; exit 1; fi
          if [ -z "${{ secrets.TS_OAUTH_SECRET }}" ]; then echo "::error::❌ TS_OAUTH_SECRET is EMPTY! Check GitHub Secrets."; exit 1; fi
          echo "✅ Secrets are present."
        
      - name: Build Server Binary
        run: cargo build --release -p server
        
      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          
      - name: Deploy Binary to Mini-PC
        run: |
          scp -o StrictHostKeyChecking=no target/release/server konrad@nixos:~/server-new
          ssh -o StrictHostKeyChecking=no konrad@nixos "sudo systemctl stop qitech-control-server && sudo mv ~/server-new /run/current-system/sw/bin/server && sudo systemctl start qitech-control-server"
          
      - name: Verify Deployment
        run: |
          ssh -o StrictHostKeyChecking=no konrad@nixos "systemctl is-active qitech-control-server"
