name: Fast Deploy (Binary Only)

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'server/**'
      - 'control-core/**'
      - 'machines/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/fast-deploy.yml'
      - 'electron/**'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcap-dev libudev-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron/package-lock.json

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Server Binary
        run: |
          cargo build --release -p server
          strip target/release/server
        
      - name: Prepare Secrets
        id: sanitize
        run: |
          CLIENT_ID=$(echo "${{ secrets.TS_OAUTH_CLIENT_ID }}" | xargs)
          CLIENT_SECRET=$(echo "${{ secrets.TS_OAUTH_SECRET }}" | xargs)
          echo "CLEAN_CLIENT_ID=$CLIENT_ID" >> $GITHUB_ENV
          echo "::add-mask::$CLIENT_ID"
          echo "CLEAN_CLIENT_SECRET=$CLIENT_SECRET" >> $GITHUB_ENV
      - name: Setup Tailscale
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ env.CLEAN_CLIENT_ID }}
          oauth-secret: ${{ env.CLEAN_CLIENT_SECRET }}
          tags: tag:ci

      - name: Build Electron UI
        working-directory: electron
        run: |
          npm install
          npm run build

      - name: Deploy Binary & UI to Mini-PC
        run: |
          ssh -o StrictHostKeyChecking=no konrad@nixos "sudo systemctl stop qitech-control-server || true; sudo mkdir -p /var/lib/qitech/electron && sudo chown -R konrad /var/lib/qitech"
          # Sync Electron assets
          scp -o StrictHostKeyChecking=no -r electron/dist/* konrad@nixos:/var/lib/qitech/electron/
          scp -o StrictHostKeyChecking=no -r electron/dist-electron/* konrad@nixos:/var/lib/qitech/electron/
          
          # Deploy Server Binary
          scp -o StrictHostKeyChecking=no -C target/release/server konrad@nixos:/tmp/qitech-server
          ssh -o StrictHostKeyChecking=no konrad@nixos '
            sudo mv /tmp/qitech-server /var/lib/qitech/server
            sudo chmod +x /var/lib/qitech/server
            sudo chown qitech-service:qitech-service /var/lib/qitech/server
            
            # Robust Patching via nix-shell (Takes ~30s but ALWAYS works)
            nix-shell -p patchelf stdenv.cc.cc openssl zlib libpcap udev systemd glib libudev-zero libcap --run "
              INTERPRETER=\$(patchelf --print-interpreter /run/current-system/sw/bin/git)
              RPATHS=\$LD_LIBRARY_PATH:/run/current-system/sw/lib
              sudo patchelf --set-interpreter \$INTERPRETER --set-rpath \$RPATHS /var/lib/qitech/server
            "
            
            sudo systemctl start qitech-control-server
          '
          
      - name: Verify Deployment
        run: |
          echo "--- ðŸš€ Health Check ---"
          ssh -o StrictHostKeyChecking=no konrad@nixos "
            systemctl is-active qitech-control-server && echo 'ONLINE' || (sudo journalctl -u qitech-control-server --no-pager -n 20 && exit 1)
          "
